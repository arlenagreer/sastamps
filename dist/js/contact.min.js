var SAPA_CONTACT=(()=>{function h(e,n){let t;return function(...r){let a=()=>{clearTimeout(t),e(...r)};clearTimeout(t),t=setTimeout(a,n)}}function l(e,n=document){try{return n.querySelector(e)}catch(t){return console.warn(`Failed to query selector "${e}":`,t),null}}var i=new Map;function c(e,n,t,o){if(!e||typeof e.addEventListener!="function"){console.warn("Invalid element provided to addEventListenerWithCleanup");return}e.addEventListener(n,t,o),i.has(e)||i.set(e,[]),i.get(e).push({event:n,handler:t,options:o})}function S(e=null){if(e){let n=i.get(e);n&&(n.forEach(({event:t,handler:o,options:r})=>{e.removeEventListener(t,o,r)}),i.delete(e))}else i.forEach((n,t)=>{n.forEach(({event:o,handler:r,options:a})=>{try{t.removeEventListener(o,r,a)}catch(s){console.warn("Failed to remove event listener:",s)}})}),i.clear()}typeof window<"u"&&window.addEventListener("beforeunload",()=>{S()});function y(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}function v(e){return/^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/.test(e)}function b(){let e=l("#contact-form");e&&w(e);let n=l("#meeting-location-map");n&&q(n),k()}function w(e){e.querySelectorAll("input, textarea").forEach(o=>{c(o,"blur",d),c(o,"input",h(d,500))}),c(e,"submit",T);let t=e.querySelector("#message");t&&E(t)}function d(e){let n=e.target,t=n.value.trim(),o=n.name||n.id;if(x(n),!t&&!n.required)return!0;let r=!0,a="";switch(o){case"name":case"firstName":case"lastName":t.length<2&&(r=!1,a="Name must be at least 2 characters long");break;case"email":y(t)||(r=!1,a="Please enter a valid email address");break;case"phone":t&&!v(t)&&(r=!1,a="Please enter a valid phone number (XXX) XXX-XXXX");break;case"message":t.length<10?(r=!1,a="Message must be at least 10 characters long"):t.length>1e3&&(r=!1,a="Message must be less than 1000 characters");break;case"subject":t.length<5&&(r=!1,a="Subject must be at least 5 characters long");break}return n.required&&!t&&(r=!1,a="This field is required"),r?L(n):F(n,a),r}function x(e){e.classList.remove("error","success");let n=e.parentNode.querySelector(".field-error");n&&n.remove()}function F(e,n){e.classList.add("error"),e.classList.remove("success");let t=document.createElement("div");t.className="field-error",t.textContent=n,t.setAttribute("role","alert"),e.parentNode.appendChild(t)}function L(e){e.classList.add("success"),e.classList.remove("error")}function E(e){let t=document.createElement("div");t.className="character-counter";let o=()=>{let r=1e3-e.value.length;t.textContent=`${r} characters remaining`,t.className=`character-counter ${r<50?"warning":""}`};e.parentNode.appendChild(t),c(e,"input",o),o()}async function T(e){e.preventDefault();let n=e.target,t=n.querySelector('button[type="submit"]'),o=t.textContent,r=n.querySelectorAll("input[required], textarea[required]"),a=!0;if(r.forEach(s=>{d({target:s})||(a=!1)}),!a){u("Please correct the errors above before submitting.","error");return}t.disabled=!0,t.textContent="Sending...";try{let s=new FormData(n),f=Object.fromEntries(s.entries()),m=await A();m&&(f.csrf_token=m);let p=await fetch("contact-handler.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)}),g=await p.json();if(p.ok&&g.success)u("Thank you! Your message has been sent successfully.","success"),n.reset(),r.forEach(C=>x(C)),typeof gtag=="function"&&gtag("event","contact_form_submit",{success:!0});else throw new Error(g.message||"Submission failed")}catch(s){console.error("Form submission failed:",s),u("Sorry, there was an error sending your message. Please try again.","error"),typeof gtag=="function"&&gtag("event","contact_form_submit",{success:!1,error:s.message})}finally{t.disabled=!1,t.textContent=o}}function u(e,n){let t=document.querySelector(".form-message");t&&t.remove();let o=document.createElement("div");o.className=`form-message ${n}`,o.textContent=e,o.setAttribute("role","alert");let r=document.querySelector("#contact-form");r.insertBefore(o,r.firstChild),n==="success"&&setTimeout(()=>{o.remove()},1e4)}async function A(){try{return(await(await fetch("csrf-token.php")).json()).token}catch(e){return console.warn("Failed to get CSRF token:",e),null}}function q(e){e.innerHTML=`
        <div class="map-container">
            <div class="map-placeholder">
                <h4>Meeting Location</h4>
                <address>
                    <strong>San Antonio Public Library</strong><br>
                    Central Branch - Conference Room B<br>
                    600 Soledad Street<br>
                    San Antonio, TX 78205
                </address>
                <div class="map-actions">
                    <a href="https://www.google.com/maps/search/?api=1&query=San+Antonio+Public+Library+Central+Branch" 
                       target="_blank" class="btn-secondary">
                        \u{1F4CD} Open in Google Maps
                    </a>
                    <button class="btn-secondary" onclick="copyAddress()">
                        \u{1F4CB} Copy Address
                    </button>
                </div>
            </div>
        </div>
    `,window.copyAddress=function(){let o="San Antonio Public Library, Central Branch - Conference Room B, 600 Soledad Street, San Antonio, TX 78205";navigator.clipboard?navigator.clipboard.writeText(o).then(()=>{n()}).catch(r=>{console.error("Failed to copy address:",r),t(o)}):t(o)};function n(){let o=e.querySelector('button[onclick="copyAddress()"]'),r=o.textContent;o.textContent="\u2705 Copied!",setTimeout(()=>{o.textContent=r},2e3)}function t(o){let r=document.createElement("textarea");r.value=o,r.style.position="fixed",r.style.opacity="0",document.body.appendChild(r),r.select();try{document.execCommand("copy"),n()}catch(a){console.error("Fallback copy failed:",a),alert("Please manually copy the address from above.")}document.body.removeChild(r)}}function k(){document.querySelectorAll("[data-copy]").forEach(n=>{c(n,"click",t=>{let o=t.target.dataset.copy||t.target.textContent;navigator.clipboard&&navigator.clipboard.writeText(o).then(()=>{N(t.target)}).catch(r=>{console.error("Failed to copy:",r)})})})}function N(e){let n=e.textContent;e.textContent="Copied!",e.style.backgroundColor="#e8f5e8",setTimeout(()=>{e.textContent=n,e.style.backgroundColor=""},1500)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",b):b();})();
