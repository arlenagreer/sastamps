(()=>{function u(e,t=document){try{return t.querySelector(e)}catch(l){return console.warn(`Failed to query selector "${e}":`,l),null}}async function g(){let e=u("#glossary-search-container");e&&await q(e);let t=u("#glossary-filters-container");t&&await F(t);let l=u("#glossary-content-container");l&&await E(l),await x()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g):g();window.initializeGlossary=g;async function q(e){try{e.innerHTML=`
            <div class="glossary-search">
                <div class="search-header">
                    <h3><i class="fas fa-search"></i> Search Glossary</h3>
                    <p>Find philatelic terms and definitions</p>
                </div>
                <div class="search-form">
                    <div class="search-input-group">
                        <input 
                            type="search" 
                            id="glossary-search-input" 
                            placeholder="Search terms, definitions, or categories..." 
                            aria-label="Search glossary terms"
                            autocomplete="off"
                        >
                        <button id="glossary-search-button" aria-label="Search" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                        <button id="glossary-clear-button" aria-label="Clear search" type="button" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="search-suggestions" id="search-suggestions" style="display: none;"></div>
                </div>
                <div id="search-results" style="display: none;"></div>
            </div>
        `;let t=e.querySelector("#glossary-search-input"),l=e.querySelector("#glossary-search-button"),a=e.querySelector("#glossary-clear-button"),c=e.querySelector("#search-results"),o;t.addEventListener("input",r=>{clearTimeout(o);let s=r.target.value.trim();s.length>0?(a.style.display="block",o=setTimeout(()=>p(s,c),300)):(a.style.display="none",c.style.display="none",w())}),l.addEventListener("click",()=>{let r=t.value.trim();r&&p(r,c)}),a.addEventListener("click",()=>{t.value="",a.style.display="none",c.style.display="none",w(),t.focus()}),t.addEventListener("keypress",r=>{if(r.key==="Enter"){r.preventDefault();let s=t.value.trim();s&&p(s,c)}})}catch(t){console.error("Failed to load glossary search:",t),e.innerHTML='<p class="error-message">Unable to load search functionality.</p>'}}async function F(e){try{let a=(await(await fetch("data/glossary/glossary.json")).json()).terms||[],c=[...new Set(a.map(i=>i.category))].sort(),o=[...new Set(a.map(i=>i.difficulty))].sort(),r=[...new Set(a.map(i=>i.subcategory).filter(Boolean))].sort();e.innerHTML=`
            <div class="glossary-filters">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="category-filter">
                            <i class="fas fa-layer-group"></i> Category
                        </label>
                        <select id="category-filter" aria-label="Filter by category">
                            <option value="">All Categories</option>
                            ${c.map(i=>`<option value="${i}">${h(i)}</option>`).join("")}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="difficulty-filter">
                            <i class="fas fa-signal"></i> Difficulty
                        </label>
                        <select id="difficulty-filter" aria-label="Filter by difficulty">
                            <option value="">All Levels</option>
                            ${o.map(i=>`<option value="${i}">${v(i)}</option>`).join("")}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="sort-filter">
                            <i class="fas fa-sort"></i> Sort By
                        </label>
                        <select id="sort-filter" aria-label="Sort terms">
                            <option value="alphabetical">Alphabetical</option>
                            <option value="category">Category</option>
                            <option value="difficulty">Difficulty</option>
                            <option value="recent">Recently Added</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <button id="filter-reset" type="button" class="btn btn-secondary">
                            <i class="fas fa-undo"></i> Reset Filters
                        </button>
                    </div>
                </div>
                
                <div class="alphabet-nav" id="alphabet-nav">
                    <span class="alphabet-label">Jump to letter:</span>
                    ${Array.from("ABCDEFGHIJKLMNOPQRSTUVWXYZ").map(i=>`<button class="alphabet-btn" data-letter="${i}">${i}</button>`).join("")}
                </div>
            </div>
        `;let s=e.querySelector("#category-filter"),n=e.querySelector("#difficulty-filter"),y=e.querySelector("#sort-filter"),f=e.querySelector("#filter-reset"),b=e.querySelectorAll(".alphabet-btn");[s,n,y].forEach(i=>{i.addEventListener("change",S)}),f.addEventListener("click",()=>{s.value="",n.value="",y.value="alphabetical",S()}),b.forEach(i=>{i.addEventListener("click",$=>{let T=$.target.dataset.letter;k(T),b.forEach(C=>C.classList.remove("active")),$.target.classList.add("active")})})}catch(t){console.error("Failed to load glossary filters:",t),e.innerHTML='<p class="error-message">Unable to load filters.</p>'}}async function E(e){try{let a=(await(await fetch("data/glossary/glossary.json")).json()).terms||[];if(a.length===0){e.innerHTML=`
                <div class="card">
                    <div class="card-content text-center">
                        <h3>No Terms Available</h3>
                        <p>The glossary is currently being updated. Please check back soon.</p>
                    </div>
                </div>
            `;return}window.glossaryTerms=a,m(a,e)}catch(t){console.error("Failed to load glossary content:",t),e.innerHTML=`
            <div class="card">
                <div class="card-content text-center">
                    <h3>Error Loading Glossary</h3>
                    <p>Unable to load glossary terms. Please try refreshing the page.</p>
                </div>
            </div>
        `}}function m(e,t){if(e.length===0){t.innerHTML=`
            <div class="card">
                <div class="card-content text-center">
                    <h3>No Terms Found</h3>
                    <p>No terms match your current search or filter criteria.</p>
                </div>
            </div>
        `;return}let l={};e.forEach(o=>{let r=o.term.charAt(0).toUpperCase();l[r]||(l[r]=[]),l[r].push(o)});let c=Object.keys(l).sort().map(o=>`
        <div class="glossary-section" id="section-${o}">
            <h2 class="glossary-letter-header">${o}</h2>
            <div class="glossary-terms">
                ${l[o].map(r=>j(r)).join("")}
            </div>
        </div>
    `).join("");t.innerHTML=c,t.addEventListener("click",o=>{if(o.target.closest(".term-header")){let r=o.target.closest(".glossary-term"),s=r.querySelector(".term-content"),n=r.querySelector(".expand-icon");s.style.display==="none"||!s.style.display?(s.style.display="block",n.style.transform="rotate(180deg)",r.classList.add("expanded")):(s.style.display="none",n.style.transform="rotate(0deg)",r.classList.remove("expanded"))}if(o.target.closest(".related-term")){o.preventDefault();let r=o.target.closest(".related-term").dataset.termId;L(r)}})}function j(e){let t=v(e.difficulty),l=h(e.category);return`
        <div class="glossary-term" id="term-${e.id}" data-term-id="${e.id}">
            <div class="term-header">
                <div class="term-title-group">
                    <h3 class="term-title">${d(e.term)}</h3>
                    ${e.alternateNames&&e.alternateNames.length>0?`<div class="alternate-names">
                            Also known as: ${e.alternateNames.map(a=>d(a)).join(", ")}
                        </div>`:""}
                </div>
                <div class="term-meta">
                    <span class="difficulty-badge difficulty-${e.difficulty}">${t}</span>
                    <span class="category-badge">${l}</span>
                    <i class="fas fa-chevron-down expand-icon"></i>
                </div>
            </div>
            
            <div class="term-content" style="display: none;">
                <div class="term-definition">
                    <p class="definition">${d(e.definition)}</p>
                    ${e.detailedDescription?`<div class="detailed-description">
                            <p>${d(e.detailedDescription)}</p>
                        </div>`:""}
                </div>
                
                ${e.examples&&e.examples.length>0?`
                    <div class="term-examples">
                        <h4><i class="fas fa-lightbulb"></i> Examples</h4>
                        <ul>
                            ${e.examples.map(a=>`
                                <li>
                                    ${d(a.description)}
                                    ${a.caption?`<span class="example-caption">${d(a.caption)}</span>`:""}
                                </li>
                            `).join("")}
                        </ul>
                    </div>
                `:""}
                
                ${e.etymology?`
                    <div class="term-etymology">
                        <h4><i class="fas fa-history"></i> Etymology</h4>
                        <p><strong>Origin:</strong> ${d(e.etymology.origin)}</p>
                        <p><strong>Meaning:</strong> ${d(e.etymology.meaning)}</p>
                        ${e.etymology.history?`<p><strong>History:</strong> ${d(e.etymology.history)}</p>`:""}
                    </div>
                `:""}
                
                ${e.relatedTerms&&e.relatedTerms.length>0?`
                    <div class="related-terms">
                        <h4><i class="fas fa-link"></i> Related Terms</h4>
                        <div class="related-terms-list">
                            ${e.relatedTerms.map(a=>`<a href="#term-${a}" class="related-term" data-term-id="${a}">${D(a)}</a>`).join("")}
                        </div>
                    </div>
                `:""}
                
                ${e.tags&&e.tags.length>0?`
                    <div class="term-tags">
                        ${e.tags.map(a=>`<span class="tag">${d(a)}</span>`).join("")}
                    </div>
                `:""}
            </div>
        </div>
    `}async function p(e,t){try{let c=(await(await fetch("data/glossary/glossary.json")).json()).terms||[],o=e.toLowerCase(),r=c.filter(s=>s.term.toLowerCase().includes(o)||s.definition.toLowerCase().includes(o)||s.detailedDescription&&s.detailedDescription.toLowerCase().includes(o)||s.tags&&s.tags.some(n=>n.toLowerCase().includes(o))||s.category&&s.category.toLowerCase().includes(o)||s.alternateNames&&s.alternateNames.some(n=>n.toLowerCase().includes(o)));r.length===0?t.innerHTML=`
                <div class="search-no-results">
                    <p><strong>No results found for "${d(e)}"</strong></p>
                    <p>Try searching for related terms or browse by category.</p>
                </div>
            `:t.innerHTML=`
                <div class="search-results-header">
                    <p>Found <strong>${r.length}</strong> result${r.length!==1?"s":""} for "<strong>${d(e)}</strong>"</p>
                </div>
                <div class="search-results-list">
                    ${r.map(s=>`
                        <div class="search-result-item">
                            <h4><a href="#term-${s.id}" onclick="scrollToTerm('${s.id}')">${d(s.term)}</a></h4>
                            <p class="result-definition">${d(s.definition)}</p>
                            <div class="result-meta">
                                <span class="result-category">${h(s.category)}</span>
                                <span class="result-difficulty">${v(s.difficulty)}</span>
                            </div>
                        </div>
                    `).join("")}
                </div>
            `,t.style.display="block"}catch(l){console.error("Search failed:",l),t.innerHTML='<p class="error-message">Search temporarily unavailable. Please try again.</p>',t.style.display="block"}}function S(){let e=document.querySelector("#category-filter")?.value||"",t=document.querySelector("#difficulty-filter")?.value||"",l=document.querySelector("#sort-filter")?.value||"alphabetical";if(!window.glossaryTerms)return;let a=[...window.glossaryTerms];switch(e&&(a=a.filter(o=>o.category===e)),t&&(a=a.filter(o=>o.difficulty===t)),l){case"category":a.sort((r,s)=>r.category!==s.category?r.category.localeCompare(s.category):r.term.localeCompare(s.term));break;case"difficulty":let o={beginner:1,intermediate:2,advanced:3};a.sort((r,s)=>{let n=o[r.difficulty]||999,y=o[s.difficulty]||999;return n!==y?n-y:r.term.localeCompare(s.term)});break;case"recent":a.sort((r,s)=>{let n=new Date(r.dateAdded||"1970-01-01");return new Date(s.dateAdded||"1970-01-01")-n});break;case"alphabetical":default:a.sort((r,s)=>r.term.localeCompare(s.term));break}let c=document.querySelector("#glossary-content-container");c&&m(a,c)}function w(){let e=document.querySelector("#glossary-content-container");e&&window.glossaryTerms&&m(window.glossaryTerms,e)}function k(e){let t=document.querySelector(`#section-${e}`);t&&t.scrollIntoView({behavior:"smooth",block:"start"})}function L(e){let t=document.querySelector(`#term-${e}`);if(t){t.scrollIntoView({behavior:"smooth",block:"center"});let l=t.querySelector(".term-content"),a=t.querySelector(".expand-icon");l&&l.style.display!=="block"&&(l.style.display="block",a&&(a.style.transform="rotate(180deg)"),t.classList.add("expanded")),t.classList.add("highlighted"),setTimeout(()=>t.classList.remove("highlighted"),2e3)}}async function x(){try{let l=(await(await fetch("data/glossary/glossary.json")).json()).terms||[],a=l.length,c=new Set(l.map(y=>y.category)).size,o=l.reduce((y,f)=>y+(f.relatedTerms?.length||0),0),r=document.querySelector("#total-terms"),s=document.querySelector("#total-categories"),n=document.querySelector("#total-references");r&&(r.textContent=a),s&&(s.textContent=c),n&&(n.textContent=o)}catch(e){console.error("Failed to load glossary stats:",e)}}function h(e){return e.split("-").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}function v(e){return e.charAt(0).toUpperCase()+e.slice(1)}function D(e){return e.split("-").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}function d(e){if(!e)return"";let t=document.createElement("div");return t.textContent=e,t.innerHTML}window.scrollToTerm=L;})();
