name: CI Testing Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Create reports directory
      run: mkdir -p reports
      
    - name: Run HTML validation
      run: npm run test:html
      continue-on-error: true
      
    - name: Run CSS validation
      run: npm run test:css
      continue-on-error: true
      
    - name: Run JavaScript linting
      run: npm run test:js
      continue-on-error: true
      
    - name: Run Markdown linting
      run: npm run test:md
      continue-on-error: true
      
    - name: Build the project
      run: npm run build
      
    - name: Start server for link checking
      run: |
        npm run serve &
        sleep 5
        
    - name: Run link checker
      run: |
        npx broken-link-checker http://localhost:3000 --recursive --exclude-external --filter-level 3 || true
        
    - name: Run accessibility tests
      run: npm run test:a11y
      continue-on-error: true
      
    - name: Run Lighthouse audit
      uses: treosh/lighthouse-ci-action@v12
      with:
        urls: |
          http://localhost:3000
          http://localhost:3000/about.html
          http://localhost:3000/meetings.html
          http://localhost:3000/contact.html
        uploadArtifacts: true
        temporaryPublicStorage: true
        
    - name: Upload test reports
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: test-reports
        path: reports/
        retention-days: 30
        
    - name: Security audit
      run: npm audit --audit-level=moderate
      continue-on-error: true

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: read
      pages: write
      id-token: write
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build for production
      run: npm run build
      
    - name: Setup Pages
      uses: actions/configure-pages@v5
      
    - name: Prepare deployment directory
      run: |
        mkdir -p _site
        # Copy HTML files from root
        cp *.html _site/ 2>/dev/null || true
        # Copy built assets
        cp -r dist _site/
        # Copy static files
        cp site.webmanifest _site/ 2>/dev/null || true
        cp .nojekyll _site/ 2>/dev/null || true
        cp -r images _site/ 2>/dev/null || true
        # Copy PHP files if they exist (for form handling)
        cp *.php _site/ 2>/dev/null || true

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '_site'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4